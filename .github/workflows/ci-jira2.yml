name: CI with Jira

on:
  workflow_dispatch:
    inputs:
      JIRA_ISSUE:
        description: 'Jira Ticket ID'
        required: false
        default: 'KAN-1'

jobs:
  build-and-update-jira:
    runs-on: ubuntu-latest
    env:
      GIT_URL: https://github.com/mudassir2222/onlinebookstore.git
      JIRA_BASE: https://mudassirkhan376.atlassian.net
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ===== Fetch Jira Details =====
      - name: Fetch Jira Details
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'KAN-1' }}"
          echo "===== Fetch Jira ====="
          echo "Issue: $ISSUE"

          RESPONSE=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -H "Accept: application/json" \
            "$JIRA_BASE/rest/api/2/issue/$ISSUE")

          if echo "$RESPONSE" | jq -e 'has("errorMessages")' >/dev/null 2>&1; then
            echo "Jira API returned error:"
            echo "$RESPONSE" | jq '.errorMessages'
            exit 1
          fi

          SUMMARY=$(echo "$RESPONSE" | jq -r '.fields.summary // "NO_SUMMARY"')
          STATUS=$(echo "$RESPONSE" | jq -r '.fields.status.name // "NO_STATUS"')
          echo "Summary: $SUMMARY"
          echo "Status: $STATUS"

      # ===== Clone Code =====
      - name: Clone Code
        run: |
          rm -rf onlinebookstore
          git clone $GIT_URL

      # ===== Build =====
      - name: Build (Maven)
        run: |
          cd onlinebookstore
          mvn clean package -DskipTests=false

      # ===== Test =====
      - name: Run Tests
        run: |
          cd onlinebookstore
          mvn test || true

      # ===== Deploy (Simulated) =====
      - name: Deploy (simulate)
        run: |
          echo "Deploying application..."
          echo "Simulated deployment 완료"

      # ===== Update Jira (Success) =====
      - name: Update Jira Ticket (success)
        if: success()
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'KAN-1' }}"
          BUILD_NO=${{ github.run_number }}

          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "{\"body\":\"✅ Build & Deployment successful from GitHub Actions run $BUILD_NO\"}" \
            "$JIRA_BASE/rest/api/2/issue/$ISSUE/comment"

      # ===== Update Jira (Failure) =====
      - name: Update Jira Ticket (failure)
        if: failure()
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'KAN-1' }}"
          BUILD_NO=${{ github.run_number }}

          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "{\"body\":\"❌ GitHub Actions run $BUILD_NO failed. Check logs.\"}" \
            "$JIRA_BASE/rest/api/2/issue/$ISSUE/comment" || true
