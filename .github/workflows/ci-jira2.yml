name: CI with Jira

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      JIRA_ISSUE:
        description: 'Jira issue key (e.g. your real Jira issue)'
        required: false
        default: 'GLOS-123'  # <-- replace with your actual Jira issue key used in Jenkins

jobs:
  build-and-update-jira:
    runs-on: ubuntu-latest
    env:
      JIRA_BASE: ${{ secrets.JIRA_BASE }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      GIT_REPO: https://github.com/mudassir2222/onlinebookstore.git

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Show Jira input
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'GLOS-123' }}"
          echo "Running workflow for Jira issue: $ISSUE"

      # ===== Stage 1: Fetch Jira details =====
      - name: Fetch Jira issue details
        id: fetch_jira
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'GLOS-123' }}"
          RESPONSE=$(curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE }}/rest/api/2/issue/${ISSUE}")

          if echo "$RESPONSE" | jq -e 'has("errorMessages")' >/dev/null 2>&1; then
            echo "Jira API returned error:"
            echo "$RESPONSE" | jq '.errorMessages'
            exit 1
          fi

          SUMMARY=$(echo "$RESPONSE" | jq -r '.fields.summary // "NO_SUMMARY"')
          STATUS=$(echo "$RESPONSE" | jq -r '.fields.status.name // "NO_STATUS"')
          echo "Jira summary: $SUMMARY"
          echo "Jira status: $STATUS"

          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      # ===== Setup Java & Build =====
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build (Maven)
        working-directory: .
        run: mvn -B -ntp -DskipTests=false clean package

      - name: Run Tests
        working-directory: .
        run: mvn test || true

      # ===== Deploy (simulated) =====
      - name: Deploy (simulate)
        run: |
          echo "Simulating deploy..."
          echo "Deploy OK"

      # ===== Jira comment: success =====
      - name: Add comment to Jira (success)
        if: success()
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'GLOS-123' }}"
          BUILD_NO=${{ github.run_number }}
          COMMENT=$(printf '{"body":"✅ Build & Deployment successful from GitHub Actions run %s (workflow: %s)"}' "$BUILD_NO" "${{ github.workflow }}")
          curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "$COMMENT" \
            "${{ secrets.JIRA_BASE }}/rest/api/2/issue/${ISSUE}/comment" \
            | jq '.id // "no-comment-id"'

      # ===== Jira comment: failure =====
      - name: Add comment to Jira (failure)
        if: failure()
        run: |
          ISSUE="${{ github.event.inputs.JIRA_ISSUE || 'GLOS-123' }}"
          BUILD_NO=${{ github.run_number }}
          COMMENT=$(printf '{"body":"❌ GitHub Actions run %s failed (workflow: %s). Check logs."}' "$BUILD_NO" "${{ github.workflow }}")
          curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "$COMMENT" \
            "${{ secrets.JIRA_BASE }}/rest/api/2/issue/${ISSUE}/comment" || true
